{% extends 'base.html' %}

{% block content %}
    <div class="container">
        <div class="row">
            <div class="span4">
                <h1>Welcome {{lastfmuser.user.username}}!</h1>
            <div class="span8">
                <canvas id="viscanvas"></canvas>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script src="{{STATIC_PATH}}js/processing-1.3.6.js"></script>
<script>
    var printMessage = function(msg) {
        console.log(msg);
    }
    
    $(document).ready(function(){
        var WIDTH = 1000;
        var HEIGHT = 800;
        var MAX_CIRCLE_WIDTH = 100;
        var BORDER = 50;
        var canvas = document.getElementById('viscanvas');
        var pjs = new Processing(canvas);
        
        var value = 0;
        
       function render_bubble( processingsketch ) {
           processingsketch.fill(pjs.random(255), pjs.random(255),pjs.random(255));
           processingsketch.ellipse(this.x, this.y, this.width, this.width);
        }
        
        function draw_name( processingsketch ) {
            processingsketch.fill( 0,0,0 );
            processingsketch.text( this.name, this.x, this.y + this.width );
        }
        
        function bubble(x, y, width, name, ps) {
            this.x = x;
            this.y = y;
            this.width = width;
            this.name = name;
            
            this.name_visible = false;
            
            this.render = render_bubble;
            this.draw_name = draw_name;
        }
        
        pjs.artist_data = {};
        pjs.setup = function() {
            pjs.size(WIDTH, HEIGHT);
            pjs.background(255);
            pjs.smooth();
            pjs.textFont(pjs.loadFont("Ziggurat-HTF-Black-32.vlw"), 8);
            var chart_url = '{{root_url}}api/topartists/?callback=?';
            $.getJSON(chart_url, function(chart_data) {
                pjs.set_artist_data(chart_data);
                pjs.redraw();
            });            
        }
        
        pjs.set_artist_data = function(data) {
           this.bubbles = [];
           
           var artist_data = data;
           var total_playcounts = [];
           var total_listeners = [];
           var user_listens = [];
           for(var i in artist_data.artists) {
               total_playcounts.push(artist_data.artists[i].total_playcount);
               total_listeners.push(artist_data.artists[i].total_listeners);
               user_listens.push(artist_data.artists[i].user_playcount);  
           }
           var max_total_playcounts = Math.max.apply(null, total_playcounts);
           var min_total_playcounts = Math.min.apply(null, total_playcounts);
           var max_total_listeners =  Math.max.apply(null, total_listeners);
           var min_total_listeners = Math.min.apply(null, total_listeners);
           var max_user_listens = Math.max.apply(null, user_listens);
           var min_user_listens = Math.min.apply(null, user_listens);
           var x_pixels_per_play = (WIDTH - 50) / (max_total_playcounts-min_total_playcounts);
           var y_pixels_per_listener = (HEIGHT - 50) / (max_total_listeners-min_total_listeners);
           var pixels_per_user_play = MAX_CIRCLE_WIDTH / (max_user_listens - min_user_listens);
           
           for(var i  in artist_data.artists) {
               var x = BORDER + x_pixels_per_play * (artist_data.artists[i].total_playcount - min_total_playcounts);
               var y = (HEIGHT -  BORDER) - (y_pixels_per_listener * (artist_data.artists[i].total_listeners - min_total_listeners));
               var width = pixels_per_user_play * (artist_data.artists[i].user_playcount - min_user_listens);
               var name = artist_data.artists[i].name;
               var b = new bubble(x, y, width, name);
               this.bubbles.push(b);
           }
        }
        
        pjs.draw = function() {
            for(var i in this.bubbles) {
                this.bubbles[i].render(pjs);
            }
            for(var i in this.bubbles) {
                this.bubbles[i].draw_name(pjs);
            }
            pjs.smooth();
        }

        pjs.setup();

    });
</script>


{% endblock %}